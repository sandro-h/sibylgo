version: 2
workflows:
  version: 2
  all:
    jobs:
      - build
      - build-vs-ext
jobs:
  build:
    working_directory: /go/src/github.com/sandro-h/sibylgo
    docker:
      - image: circleci/golang:1.11.2-stretch

    steps:
      - checkout

      ##############################
      # Fetch dependencies
      ##############################
      - restore_cache:
          name: Restore dependency cache
          keys:
            - v1-deps-{{ checksum "Gopkg.lock" }}
      - run:
          name: Install go dep
          command: curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
      - run: 
          name: Get dependencies
          command: dep ensure --vendor-only -v
      - save_cache:
          name: Save dependency cache
          paths:
            - vendor
          key: v1-deps-{{ checksum "Gopkg.lock" }}

      ##############################
      # Test and build sibylgo
      ##############################
      - run:
          name: Test
          command: go test -v -coverprofile="coverage.out" ./...

      - run:
          name: Build for linux
          command: go build -v -ldflags="-X 'main.buildVersion=$(cat version.txt)' -X 'main.buildNumber=$CIRCLE_BUILD_NUM' -X 'main.buildRevision=${CIRCLE_SHA1:0:7}'"

      - run:
          name: Build for windows
          command: GOOS=windows GOARCH=amd64 go build -v -ldflags="-X 'main.buildVersion=$(cat version.txt)' -X 'main.buildNumber=$CIRCLE_BUILD_NUM' -X 'main.buildRevision=${CIRCLE_SHA1:0:7}'"

      - store_artifacts:
          path: sibylgo
          destination: binaries/sibylgo
      - store_artifacts:
          path: sibylgo.exe
          destination: binaries/sibylgo.exe
      - store_artifacts:
          path: sibylcal.html
          destination: binaries/sibylcal.html

      ##############################
      # Sonar
      ##############################

    # Excluded because sonarcloud doesn't support free private github repos.
    #   - restore_cache:
    #       name: Restore buildtools cache
    #       key: v1-buildtools

    #   - run:
    #       name: Fetch sonar scanner
    #       command: |
    #         if [ ! -d buildtools/sonar-scanner ]; then
    #           wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-3.2.0.1227-linux.zip
    #           unzip -d buildtools/ sonar-scanner-cli-3.2.0.1227-linux.zip
    #           mv buildtools/sonar-scanner-3.2.0.1227-linux buildtools/sonar-scanner
    #         fi

    #   - save_cache:
    #       name: Save buildtools cache
    #       paths:
    #         - buildtools
    #       key: v1-buildtools

    #   - run:
    #       name: Run sonar analysis
    #       command: |
    #         buildtools/sonar-scanner/bin/sonar-scanner \
    #           -Dsonar.host.url=https://sonarcloud.io \
    #           -Dsonar.login=$SONAR_TOKEN

  build-vs-ext:
    docker:
      - image: circleci/node:10.15

    steps:
      - checkout

      - restore_cache:
          name: Restore node_modules cache
          key: v1-node_modules-{{ checksum "vscode_ext/package-lock.json" }}

      - run:
          working_directory: vscode_ext
          name: Install
          command: "[ -d node_modules ] || npm install --unsafe-perm"

      - save_cache:
          name: Save node_modules cache
          paths:
            - vscode_ext/node_modules
          key: v1-node_modules-{{ checksum "vscode_ext/package-lock.json" }}

      - run:
          working_directory: vscode_ext
          name: Update version
          command: npm version $(cat ../version.txt)

      - run:
          working_directory: vscode_ext
          name: Build
          command: node node_modules/vsce/out/vsce package -o sibyl.vsix

      - store_artifacts:
          path: vscode_ext/sibyl.vsix
          destination: sibyl.vsix